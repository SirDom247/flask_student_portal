{% extends "base.html" %}

{% block title %}Login - PDE Portal{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full space-y-8">
        <!-- Header -->
        <div class="text-center">
            <div class="mx-auto w-20 h-20 bg-gradient-to-r from-green-500 to-emerald-600 rounded-full flex items-center justify-center mb-4 shadow-lg">
                <i class="fas fa-user-shield text-white text-2xl"></i>
            </div>
            <h2 class="text-3xl font-bold bg-gradient-to-r from-green-400 to-emerald-500 bg-clip-text text-transparent">
                Secure Login
            </h2>
            <p class="mt-2 text-gray-400 text-lg">Sign in to your account</p>
        </div>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="space-y-2">
                    {% for category, message in messages %}
                        <div class="p-4 rounded-xl border {% if category == 'success' %}bg-green-900 bg-opacity-20 border-green-800 text-green-400{% elif category == 'error' %}bg-red-900 bg-opacity-20 border-red-800 text-red-400{% else %}bg-blue-900 bg-opacity-20 border-blue-800 text-blue-400{% endif %}">
                            <div class="flex items-center">
                                <i class="fas fa-{% if category == 'success' %}check-circle{% elif category == 'error' %}exclamation-triangle{% else %}info-circle{% endif %} mr-3"></i>
                                <span>{{ message }}</span>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <!-- Login Form -->
        <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl p-8 border border-gray-700 shadow-2xl">
            <form method="POST" action="{{ url_for('login') }}" class="space-y-6" id="loginForm">
                {{ form.hidden_tag() }}
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                
                <!-- Email -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">
                        <i class="fas fa-envelope mr-2 text-green-400"></i>Email Address
                    </label>
                    <input type="email" name="email" required
                           class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-300"
                           placeholder="Enter your institutional email"
                           autocomplete="email"
                           id="email"
                           value="{{ request.form.email if request.form }}">
                </div>

                <!-- Password -->
                <div class="relative">
                    <label class="block text-sm font-medium text-gray-300 mb-2">
                        <i class="fas fa-lock mr-2 text-green-400"></i>Password
                    </label>
                    <input type="password" id="password" name="password" required
                           class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-300 pr-12"
                           placeholder="Enter your password"
                           autocomplete="current-password"
                           minlength="8">
                    <button type="button" onclick="togglePassword('password', this)"
                            class="absolute right-3 top-10 text-gray-400 hover:text-green-400 transition-colors duration-200"
                            aria-label="Toggle password visibility">
                        <i class="fas fa-eye" id="password-icon"></i>
                    </button>
                </div>

                <!-- Security Features -->
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <input type="checkbox" id="remember_me" name="remember_me" 
                               class="w-4 h-4 text-green-600 bg-gray-700 border-gray-600 rounded focus:ring-green-500 focus:ring-2">
                        <label for="remember_me" class="ml-2 text-sm text-gray-300">Remember this device</label>
                    </div>
                </div>

                <!-- Submit Button -->
                <button type="submit"
                        class="w-full bg-gradient-to-r from-green-600 to-emerald-700 text-white py-4 rounded-xl font-semibold hover:shadow-2xl transition-all duration-300 hover:scale-105 transform shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                        id="login-btn">
                    <i class="fas fa-sign-in-alt mr-2"></i>Secure Sign In
                </button>

                <!-- Support Links -->
                <div class="text-center space-y-2">
                    <a href="{{ url_for('register') }}" 
                       class="block text-green-400 hover:text-green-300 text-sm transition-colors duration-200">
                        <i class="fas fa-user-plus mr-1"></i>Create new account
                    </a>
                    <a href="{{ url_for('forgot_password') }}" 
                       class="block text-blue-400 hover:text-blue-300 text-sm transition-colors duration-200">
                        <i class="fas fa-key mr-1"></i>Forgot your password?
                    </a>
                    <a href="#" onclick="showSupportModal()" 
                       class="block text-yellow-400 hover:text-yellow-300 text-sm transition-colors duration-200">
                        <i class="fas fa-question-circle mr-1"></i>Login assistance
                    </a>
                </div>
            </form>
        </div>

        <!-- Security Notice -->
        <div class="bg-blue-900 bg-opacity-20 rounded-xl p-4 border border-blue-800">
            <div class="flex items-start">
                <i class="fas fa-shield-alt text-blue-400 mt-1 mr-3"></i>
                <div>
                    <p class="text-sm text-blue-300 font-medium">Secure Connection</p>
                    <p class="text-xs text-blue-400 mt-1">Your login is protected with industry-standard security measures.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Support Modal -->
<div id="supportModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl border border-gray-700 max-w-md w-full mx-4 p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold text-white">Login Assistance</h3>
            <button type="button" onclick="closeSupportModal()" class="text-gray-400 hover:text-white">
                <i class="fas fa-times text-lg"></i>
            </button>
        </div>
        
        <p class="text-gray-300 mb-4 text-sm">
            For login issues or password reset, please contact the system administrator.
        </p>
        
        <div class="space-y-3 text-sm text-gray-400">
            <div class="flex items-center">
                <i class="fas fa-envelope text-green-400 mr-3 w-4"></i>
                <span>admin@fcetomoku.edu.ng</span>
            </div>
            <div class="flex items-center">
                <i class="fas fa-phone text-green-400 mr-3 w-4"></i>
                <span>IT Support Desk</span>
            </div>
        </div>
        
        <div class="flex pt-4">
            <button type="button" onclick="closeSupportModal()" 
                    class="w-full bg-gray-600 hover:bg-gray-700 text-white py-3 rounded-xl font-semibold transition-all duration-300">
                Close
            </button>
        </div>
    </div>
</div>

<script>
    // Client-side rate limiting
    let loginAttempts = 0;
    const maxAttempts = 10; // Reduced for better UX
    let lockoutTimeout = null;

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
        const loginForm = document.getElementById('loginForm');
        const loginBtn = document.getElementById('login-btn');
        
        // Load attempt count from sessionStorage
        const savedAttempts = sessionStorage.getItem('loginAttempts');
        if (savedAttempts) {
            loginAttempts = parseInt(savedAttempts);
        }

        // Check if user is currently locked out
        const lockoutUntil = sessionStorage.getItem('lockoutUntil');
        if (lockoutUntil && Date.now() < parseInt(lockoutUntil)) {
            disableLoginForm();
            const remainingTime = Math.ceil((parseInt(lockoutUntil) - Date.now()) / 1000 / 60);
            showNotification(`Too many login attempts. Try again in ${remainingTime} minutes.`, 'error');
        }

        loginForm.addEventListener('submit', function(e) {
            // Basic client-side validation
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!email || !password) {
                e.preventDefault();
                showNotification('Please fill in all required fields.', 'error');
                return;
            }

            // Email format validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                e.preventDefault();
                showNotification('Please enter a valid email address.', 'error');
                return;
            }

            // Password length validation
            if (password.length < 8) {
                e.preventDefault();
                showNotification('Password must be at least 8 characters long.', 'error');
                return;
            }

            loginAttempts++;
            sessionStorage.setItem('loginAttempts', loginAttempts);

            if (loginAttempts >= maxAttempts) {
                e.preventDefault();
                const lockoutTime = Date.now() + 300000; // 5 minutes
                sessionStorage.setItem('lockoutUntil', lockoutTime);
                disableLoginForm();
                showNotification('Too many login attempts. Account locked for 5 minutes.', 'error');
                
                // Auto-reset after 5 minutes
                lockoutTimeout = setTimeout(() => {
                    resetLoginAttempts();
                    showNotification('You can now try to login again.', 'info');
                }, 300000);
            }
        });

        // Auto-clear attempts after 30 minutes of inactivity
        setTimeout(resetLoginAttempts, 1800000);
    });

    // Toggle password visibility
    function togglePassword(id, btn) {
        const input = document.getElementById(id);
        const icon = btn.querySelector('i');
        
        if (input.type === "password") {
            input.type = "text";
            icon.className = "fas fa-eye-slash";
            btn.classList.add('text-green-400');
        } else {
            input.type = "password";
            icon.className = "fas fa-eye";
            btn.classList.remove('text-green-400');
        }
    }

    // Support Modal Functions
    function showSupportModal() {
        document.getElementById('supportModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeSupportModal() {
        document.getElementById('supportModal').classList.add('hidden');
        document.body.style.overflow = 'auto';
    }

    // Disable login form during lockout
    function disableLoginForm() {
        const loginBtn = document.getElementById('login-btn');
        const inputs = document.querySelectorAll('#loginForm input');
        
        loginBtn.disabled = true;
        loginBtn.innerHTML = '<i class="fas fa-lock mr-2"></i>Account Temporarily Locked';
        inputs.forEach(input => input.disabled = true);
    }

    // Enable login form after lockout
    function enableLoginForm() {
        const loginBtn = document.getElementById('login-btn');
        const inputs = document.querySelectorAll('#loginForm input');
        
        loginBtn.disabled = false;
        loginBtn.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i>Secure Sign In';
        inputs.forEach(input => input.disabled = false);
    }

    // Reset login attempts
    function resetLoginAttempts() {
        loginAttempts = 0;
        sessionStorage.removeItem('loginAttempts');
        sessionStorage.removeItem('lockoutUntil');
        enableLoginForm();
        
        if (lockoutTimeout) {
            clearTimeout(lockoutTimeout);
            lockoutTimeout = null;
        }
    }

    // Notification system
    function showNotification(message, type = 'info') {
        // Remove existing notifications
        const existingNotifications = document.querySelectorAll('.custom-notification');
        existingNotifications.forEach(notification => notification.remove());

        // Create notification element
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 px-6 py-3 rounded-xl shadow-lg z-50 transform transition-all duration-300 custom-notification ${
            type === 'success' ? 'bg-green-600 text-white border border-green-500' :
            type === 'error' ? 'bg-red-600 text-white border border-red-500' :
            type === 'warning' ? 'bg-yellow-600 text-white border border-yellow-500' :
            'bg-blue-600 text-white border border-blue-500'
        }`;
        
        notification.innerHTML = `
            <div class="flex items-center">
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : type === 'warning' ? 'exclamation-circle' : 'info-circle'} mr-3"></i>
                <span class="flex-1">${message}</span>
                <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 5000);
    }

    // Close modal when clicking outside
    document.addEventListener('click', function(event) {
        const modal = document.getElementById('supportModal');
        if (event.target === modal) {
            closeSupportModal();
        }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeSupportModal();
        }
    });

    // Enhanced input validation
    document.getElementById('email')?.addEventListener('blur', function() {
        const email = this.value;
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        
        if (email && !emailRegex.test(email)) {
            this.classList.add('border-red-500');
            showNotification('Please enter a valid email address.', 'error');
        } else {
            this.classList.remove('border-red-500');
        }
    });

    document.getElementById('password')?.addEventListener('input', function() {
        if (this.value.length > 0 && this.value.length < 8) {
            this.classList.add('border-yellow-500');
        } else {
            this.classList.remove('border-yellow-500');
        }
    });

    // Auto-focus on email field
    document.getElementById('email')?.focus();
</script>

<style>
    .custom-notification {
        animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    input:focus {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
    }
    
    input:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    button, a, input, select, textarea {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
</style>
{% endblock %}