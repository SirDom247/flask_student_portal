{% extends "base.html" %}
{% block title %}Analytics Dashboard - PDE Portal{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-900 to-black py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- Header Section -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">Academic Analytics</h1>
            <p class="text-gray-400 text-lg">Comprehensive performance insights and statistics</p>
        </div>

        <!-- Quick Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-gradient-to-br from-green-900 to-emerald-800 rounded-2xl p-6 border border-green-700">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-green-200 text-sm">Total Students</p>
                        <p class="text-3xl font-bold text-white">{{ stats.total_students }}</p>
                    </div>
                    <div class="w-12 h-12 bg-green-500 bg-opacity-30 rounded-xl flex items-center justify-center">
                        <i class="fas fa-users text-green-300 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-gradient-to-br from-blue-900 to-blue-800 rounded-2xl p-6 border border-blue-700">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-blue-200 text-sm">Total Results</p>
                        <p class="text-3xl font-bold text-white">{{ stats.total_results }}</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-500 bg-opacity-30 rounded-xl flex items-center justify-center">
                        <i class="fas fa-chart-bar text-blue-300 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-gradient-to-br from-purple-900 to-purple-800 rounded-2xl p-6 border border-purple-700">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-purple-200 text-sm">Pass Rate</p>
                        <p class="text-3xl font-bold text-white">
                            {% if stats.total_results > 0 %}
                                {{ ((stats.chart_pass / stats.total_results) * 100)|round(1) }}%
                            {% else %}
                                0%
                            {% endif %}
                        </p>
                    </div>
                    <div class="w-12 h-12 bg-purple-500 bg-opacity-30 rounded-xl flex items-center justify-center">
                        <i class="fas fa-graduation-cap text-purple-300 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-gradient-to-br from-orange-900 to-orange-800 rounded-2xl p-6 border border-orange-700">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-orange-200 text-sm">Avg CGPA</p>
                        <p class="text-3xl font-bold text-white">
                            {% if chart_data.student_cgpas %}
                                {{ (chart_data.student_cgpas|sum / chart_data.student_cgpas|length)|round(2) }}
                            {% else %}
                                0.00
                            {% endif %}
                        </p>
                    </div>
                    <div class="w-12 h-12 bg-orange-500 bg-opacity-30 rounded-xl flex items-center justify-center">
                        <i class="fas fa-star text-orange-300 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Analytics Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Grade Distribution Chart -->
            <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl p-6 border border-gray-700">
                <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                    <i class="fas fa-chart-pie text-green-400 mr-3"></i>
                    Grade Distribution
                </h3>
                <div class="h-80 flex items-center justify-center">
                    <div id="gradeChart" class="w-full h-full">
                        <!-- Chart will be rendered here -->
                        <div class="flex items-center justify-center h-full text-gray-400">
                            <div class="text-center">
                                <i class="fas fa-chart-pie text-4xl mb-2 opacity-50"></i>
                                <p>Grade distribution chart</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Course Performance -->
            <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl p-6 border border-gray-700">
                <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                    <i class="fas fa-chart-bar text-blue-400 mr-3"></i>
                    Course Performance
                </h3>
                <div class="h-80 flex items-center justify-center">
                    <div id="courseChart" class="w-full h-full">
                        <!-- Chart will be rendered here -->
                        <div class="flex items-center justify-center h-full text-gray-400">
                            <div class="text-center">
                                <i class="fas fa-chart-bar text-4xl mb-2 opacity-50"></i>
                                <p>Course performance chart</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Statistics Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            <!-- Pass/Fail Statistics -->
            <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl p-6 border border-gray-700">
                <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                    <i class="fas fa-chart-line text-purple-400 mr-3"></i>
                    Pass/Fail Overview
                </h3>
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-300">Passed Students</span>
                        <span class="text-green-400 font-bold">{{ stats.chart_pass }}</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-3">
                        <div class="bg-green-500 h-3 rounded-full" 
                             style="width: {% if stats.total_results > 0 %}{{ (stats.chart_pass / stats.total_results) * 100 }}%{% else %}0%{% endif %}"></div>
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <span class="text-gray-300">Failed Students</span>
                        <span class="text-red-400 font-bold">{{ stats.chart_fail }}</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-3">
                        <div class="bg-red-500 h-3 rounded-full" 
                             style="width: {% if stats.total_results > 0 %}{{ (stats.chart_fail / stats.total_results) * 100 }}%{% else %}0%{% endif %}"></div>
                    </div>
                    
                    <div class="text-center mt-4">
                        <p class="text-gray-400 text-sm">Overall Pass Rate</p>
                        <p class="text-2xl font-bold text-white">
                            {% if stats.total_results > 0 %}
                                {{ ((stats.chart_pass / stats.total_results) * 100)|round(1) }}%
                            {% else %}
                                0%
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>

            <!-- Top Performing Courses -->
            <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl p-6 border border-gray-700">
                <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                    <i class="fas fa-trophy text-yellow-400 mr-3"></i>
                    Top Courses
                </h3>
                <div class="space-y-3">
                    {% if chart_data.course_performance %}
                        {% for course in chart_data.course_performance[:5] %}
                        <div class="flex justify-between items-center p-3 bg-gray-750 rounded-lg">
                            <div>
                                <div class="text-white font-medium">{{ course.course_code }}</div>
                                <div class="text-gray-400 text-sm">{{ course.course_title[:30] }}{% if course.course_title|length > 30 %}...{% endif %}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-green-400 font-bold">{{ "%.1f"|format(course.average_score) }}</div>
                                <div class="text-gray-400 text-sm">avg</div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center text-gray-400 py-4">
                            <i class="fas fa-trophy text-2xl mb-2 opacity-50"></i>
                            <p>No course data available</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- CGPA Distribution -->
            <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl p-6 border border-gray-700">
                <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                    <i class="fas fa-chart-area text-blue-400 mr-3"></i>
                    CGPA Statistics
                </h3>
                <div class="space-y-4">
                    {% if chart_data.student_cgpas %}
                        {% set avg_cgpa = (chart_data.student_cgpas|sum / chart_data.student_cgpas|length)|round(2) %}
                        {% set max_cgpa = chart_data.student_cgpas|max|round(2) %}
                        {% set min_cgpa = chart_data.student_cgpas|min|round(2) %}
                        
                        <div class="text-center">
                            <div class="text-3xl font-bold text-white mb-2">{{ avg_cgpa }}</div>
                            <div class="text-gray-400 text-sm">Average CGPA</div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div class="text-center">
                                <div class="text-green-400 font-bold text-lg">{{ max_cgpa }}</div>
                                <div class="text-gray-400 text-xs">Highest</div>
                            </div>
                            <div class="text-center">
                                <div class="text-red-400 font-bold text-lg">{{ min_cgpa }}</div>
                                <div class="text-gray-400 text-xs">Lowest</div>
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <div class="text-purple-400 font-bold text-lg">{{ chart_data.student_cgpas|length }}</div>
                            <div class="text-gray-400 text-xs">Students with CGPA</div>
                        </div>
                    {% else %}
                        <div class="text-center text-gray-400 py-4">
                            <i class="fas fa-chart-area text-2xl mb-2 opacity-50"></i>
                            <p>No CGPA data available</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Monthly Trends and Additional Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Monthly Upload Trends -->
            <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl p-6 border border-gray-700">
                <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                    <i class="fas fa-calendar-alt text-green-400 mr-3"></i>
                    Monthly Activity
                </h3>
                <div class="h-64">
                    <div id="monthlyChart" class="w-full h-full">
                        <!-- Chart will be rendered here -->
                        <div class="flex items-center justify-center h-full text-gray-400">
                            <div class="text-center">
                                <i class="fas fa-calendar text-4xl mb-2 opacity-50"></i>
                                <p>Monthly trends chart</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Performance Metrics -->
            <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl p-6 border border-gray-700">
                <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                    <i class="fas fa-tachometer-alt text-orange-400 mr-3"></i>
                    Performance Metrics
                </h3>
                <div class="space-y-6">
                    <div>
                        <div class="flex justify-between mb-2">
                            <span class="text-gray-300">Academic Excellence</span>
                            <span class="text-green-400 font-bold">
                                {% if chart_data.grade_distribution %}
                                    {{ (chart_data.grade_distribution.get('A', 0) / stats.total_results * 100)|round(1) if stats.total_results > 0 else 0 }}%
                                {% else %}
                                    0%
                                {% endif %}
                            </span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2">
                            <div class="bg-green-500 h-2 rounded-full" 
                                 style="width: {% if chart_data.grade_distribution and stats.total_results > 0 %}{{ (chart_data.grade_distribution.get('A', 0) / stats.total_results) * 100 }}%{% else %}0%{% endif %}"></div>
                        </div>
                    </div>
                    
                    <div>
                        <div class="flex justify-between mb-2">
                            <span class="text-gray-300">Satisfactory Performance</span>
                            <span class="text-blue-400 font-bold">
                                {% if chart_data.grade_distribution %}
                                    {{ ((chart_data.grade_distribution.get('B', 0) + chart_data.grade_distribution.get('C', 0)) / stats.total_results * 100)|round(1) if stats.total_results > 0 else 0 }}%
                                {% else %}
                                    0%
                                {% endif %}
                            </span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2">
                            <div class="bg-blue-500 h-2 rounded-full" 
                                 style="width: {% if chart_data.grade_distribution and stats.total_results > 0 %}{{ ((chart_data.grade_distribution.get('B', 0) + chart_data.grade_distribution.get('C', 0)) / stats.total_results) * 100 }}%{% else %}0%{% endif %}"></div>
                        </div>
                    </div>
                    
                    <div>
                        <div class="flex justify-between mb-2">
                            <span class="text-gray-300">Need Improvement</span>
                            <span class="text-red-400 font-bold">
                                {% if chart_data.grade_distribution %}
                                    {{ ((chart_data.grade_distribution.get('D', 0) + chart_data.grade_distribution.get('F', 0)) / stats.total_results * 100)|round(1) if stats.total_results > 0 else 0 }}%
                                {% else %}
                                    0%
                                {% endif %}
                            </span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2">
                            <div class="bg-red-500 h-2 rounded-full" 
                                 style="width: {% if chart_data.grade_distribution and stats.total_results > 0 %}{{ ((chart_data.grade_distribution.get('D', 0) + chart_data.grade_distribution.get('F', 0)) / stats.total_results) * 100 }}%{% else %}0%{% endif %}"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="mt-8 flex flex-col sm:flex-row gap-4 justify-center">
            <a href="{{ url_for('dashboard_officer') }}" 
               class="bg-gradient-to-r from-green-600 to-emerald-700 text-white px-8 py-3 rounded-xl font-semibold hover:shadow-2xl transition-all duration-300 hover:scale-105 transform text-center">
                <i class="fas fa-tachometer-alt mr-2"></i>Back to Dashboard
            </a>
            <button onclick="printAnalytics()" 
                    class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-8 py-3 rounded-xl font-semibold hover:shadow-2xl transition-all duration-300 hover:scale-105 transform">
                <i class="fas fa-print mr-2"></i>Print Report
            </button>
            <button onclick="exportAnalytics()" 
                    class="bg-gradient-to-r from-purple-600 to-purple-700 text-white px-8 py-3 rounded-xl font-semibold hover:shadow-2xl transition-all duration-300 hover:scale-105 transform">
                <i class="fas fa-file-export mr-2"></i>Export Data
            </button>
        </div>
    </div>
</div>

<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
.hover\:bg-gray-750:hover {
    background-color: rgba(55, 65, 81, 0.5);
}

.bg-gray-750 {
    background-color: rgba(55, 65, 81, 0.5);
}

@media print {
    .no-print {
        display: none !important;
    }
    
    body {
        background: white !important;
        color: black !important;
    }
    
    .bg-gradient-to-br {
        background: white !important;
        border: 1px solid #ddd !important;
    }
    
    .text-white {
        color: black !important;
    }
    
    .text-gray-400 {
        color: #666 !important;
    }
}
</style>

<script>
// Initialize charts when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
});

function initializeCharts() {
    // Grade Distribution Pie Chart
    const gradeCtx = document.createElement('canvas');
    document.getElementById('gradeChart').innerHTML = '';
    document.getElementById('gradeChart').appendChild(gradeCtx);
    
    new Chart(gradeCtx, {
        type: 'pie',
        data: {
            labels: ['A', 'B', 'C', 'D', 'F'],
            datasets: [{
                data: [
                    {{ chart_data.grade_distribution.get('A', 0) }},
                    {{ chart_data.grade_distribution.get('B', 0) }},
                    {{ chart_data.grade_distribution.get('C', 0) }},
                    {{ chart_data.grade_distribution.get('D', 0) }},
                    {{ chart_data.grade_distribution.get('F', 0) }}
                ],
                backgroundColor: [
                    '#10b981', '#34d399', '#6ee7b7', '#fbbf24', '#ef4444'
                ],
                borderWidth: 2,
                borderColor: '#1f2937'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#d1d5db',
                        font: {
                            size: 12
                        }
                    }
                },
                title: {
                    display: true,
                    text: 'Grade Distribution',
                    color: '#d1d5db',
                    font: {
                        size: 14,
                        weight: 'bold'
                    }
                }
            }
        }
    });

    // Course Performance Bar Chart
    const courseCtx = document.createElement('canvas');
    document.getElementById('courseChart').innerHTML = '';
    document.getElementById('courseChart').appendChild(courseCtx);
    
    const courseLabels = {{ chart_data.course_performance|map(attribute='course_code')|list|tojson }};
    const courseData = {{ chart_data.course_performance|map(attribute='average_score')|list|tojson }};
    
    new Chart(courseCtx, {
        type: 'bar',
        data: {
            labels: courseLabels,
            datasets: [{
                label: 'Average Score',
                data: courseData,
                backgroundColor: '#3b82f6',
                borderColor: '#1d4ed8',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        color: '#9ca3af'
                    },
                    grid: {
                        color: '#374151'
                    }
                },
                x: {
                    ticks: {
                        color: '#9ca3af'
                    },
                    grid: {
                        color: '#374151'
                    }
                }
            },
            plugins: {
                legend: {
                    labels: {
                        color: '#d1d5db'
                    }
                }
            }
        }
    });

    // Monthly Trends Line Chart
    const monthlyCtx = document.createElement('canvas');
    document.getElementById('monthlyChart').innerHTML = '';
    document.getElementById('monthlyChart').appendChild(monthlyCtx);
    
    const monthLabels = {{ stats.chart_trend_labels|tojson }};
    const monthData = {{ stats.chart_trend_data|tojson }};
    
    new Chart(monthlyCtx, {
        type: 'line',
        data: {
            labels: monthLabels,
            datasets: [{
                label: 'Results Uploaded',
                data: monthData,
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#9ca3af'
                    },
                    grid: {
                        color: '#374151'
                    }
                },
                x: {
                    ticks: {
                        color: '#9ca3af'
                    },
                    grid: {
                        color: '#374151'
                    }
                }
            },
            plugins: {
                legend: {
                    labels: {
                        color: '#d1d5db'
                    }
                }
            }
        }
    });
}

function printAnalytics() {
    window.print();
}

function exportAnalytics() {
    // Create a simple CSV export of key metrics
    let csvContent = "data:text/csv;charset=utf-8,";
    csvContent += "Metric,Value\n";
    csvContent += `Total Students,${ {{ stats.total_students }} }\n`;
    csvContent += `Total Results,${ {{ stats.total_results }} }\n`;
    csvContent += `Pass Rate,${ {% if stats.total_results > 0 %}{{ ((stats.chart_pass / stats.total_results) * 100)|round(1) }}{% else %}0{% endif %} }%\n`;
    csvContent += `Average CGPA,${ {% if chart_data.student_cgpas %}{{ (chart_data.student_cgpas|sum / chart_data.student_cgpas|length)|round(2) }}{% else %}0.00{% endif %} }\n`;
    
    // Create download link
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `analytics_export_${new Date().toISOString().slice(0,10)}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Smart auto-refresh system
let lastUpdate = new Date();

function startSmartRefresh() {
    // Refresh every 2 minutes
    setInterval(() => {
        showRefreshNotification();
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    }, 120000);
    
    // Also refresh when page becomes visible (user returns to tab)
    document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
            // Check if it's been more than 1 minute since last refresh
            const now = new Date();
            const timeDiff = (now - lastUpdate) / 1000 / 60; // minutes
            
            if (timeDiff > 1) {
                console.log('Tab refocused after', timeDiff.toFixed(1), 'minutes - refreshing');
                window.location.reload();
            }
        }
    });
}

function showRefreshNotification() {
    // Create or show notification
    let notification = document.getElementById('refreshNotification');
    if (!notification) {
        notification = document.createElement('div');
        notification.id = 'refreshNotification';
        notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50';
        notification.innerHTML = '<i class="fas fa-sync-alt animate-spin mr-2"></i>Updating analytics...';
        document.body.appendChild(notification);
    }
    
    notification.classList.remove('hidden');
    setTimeout(() => {
        notification.classList.add('hidden');
    }, 3000);
}

// Add refresh button to UI
function addRefreshControls() {
    const actionDiv = document.querySelector('.flex.flex-col.sm\\:flex-row.gap-4.justify-center');
    if (actionDiv) {
        const refreshBtn = document.createElement('button');
        refreshBtn.innerHTML = '<i class="fas fa-sync-alt mr-2"></i>Refresh Now';
        refreshBtn.className = 'bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-3 rounded-xl font-semibold hover:shadow-xl transition-all duration-300 hover:scale-105 transform';
        refreshBtn.onclick = () => {
            showRefreshNotification();
            setTimeout(() => window.location.reload(), 500);
        };
        
        actionDiv.appendChild(refreshBtn);
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    addRefreshControls();
    startSmartRefresh();
    
    // Show last update time
    const lastUpdateEl = document.createElement('div');
    lastUpdateEl.className = 'text-center text-gray-400 text-sm mt-4';
    lastUpdateEl.innerHTML = `<i class="fas fa-clock mr-2"></i>Last updated: ${new Date().toLocaleTimeString()}`;
    document.querySelector('.max-w-7xl.mx-auto').appendChild(lastUpdateEl);
});

</script>
{% endblock %}